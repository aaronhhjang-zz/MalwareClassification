import pandas as pd
import os
import glob

import scipy
from sklearn.preprocessing import LabelEncoder
from sklearn import tree
import numpy as np
import dataPreprocessing
from sklearn.model_selection import train_test_split
from sklearn.metrics import confusion_matrix
from sklearn.metrics import accuracy_score
from sklearn.ensemble import RandomForestClassifier
from sklearn.model_selection import RandomizedSearchCV
from sklearn.model_selection import KFold
from sklearn.svm import SVC

path_to_json = r".\simplifiedReports\\"

def get_score(model, X_train, X_test, y_train, y_test):
    model.fit(X_train, y_train)
    print("=============SCORE OF " + str(model) + " ==================")
    print(model.score(X_test, y_test))
    #return model.score(X_test, y_test)

#read all json files into pandas dataframe
json_pattern = os.path.join(path_to_json,'*.json')
file_list = glob.glob(json_pattern)
dfs = [] # an empty list to store the data frames
for file in file_list:
    data = pd.read_json(file, lines=True) # read data frame from json file
    dfs.append(data) # append the data frame to the list
df = pd.concat(dfs, ignore_index=True) # concatenate all the data frames in the list.

#making "inputs" dataframe
#split data into inputs and target (X and Y)
inputs = df.drop(['signatures','family'], axis='columns')
#inputs = inputs.drop('family', axis='columns')
target = df['family']

index = 0
for feature in dataPreprocessing.FEATURES:
    inputs[feature] = dataPreprocessing.transposedFeatureMatrix[index]
    index += 1


# Encode data
le_name = LabelEncoder()
le_score = LabelEncoder()
inputs['nameNEW'] = le_name.fit_transform(inputs['name'])
inputs['scoreNEW'] = le_score.fit_transform(inputs['score'])
inputs = inputs.drop(["name", "score"], axis = "columns")
#shuffles dataframe (to randomize data order)
inputs.sample(frac=1).reset_index(drop=True)

X_train, X_test, y_train, y_test = train_test_split(inputs, target,test_size=0.2, random_state=0)
#decision tree
tree_vanilla = tree.DecisionTreeClassifier()

#list of parameter combinations to try
params_tree = {"max_depth": [3, None],
          "min_samples_leaf" : [1,4],
          "criterion": ["gini", "entropy"]
          }

tree_cv = RandomizedSearchCV(tree_vanilla, params_tree, cv=5)

#list of parameter combinations to try
# params_svm = {"C": [1, 8],
#           "kernel" : ["rbf","linear","poly","sigmoid"],
#           "gamma": ["scale", "auto"]
#           }

params_svm = {'C': scipy.stats.expon(scale=100), 'gamma': scipy.stats.expon(scale=.1),
  'kernel': ['rbf'], 'class_weight':['balanced', None]}
svmModel = RandomizedSearchCV(SVC(), params_svm,cv=5)


tree_cv.fit(X_train, y_train)

get_score(tree_vanilla, X_train, X_test, y_train, y_test)
get_score(tree_cv, X_train, X_test, y_train, y_test)
get_score(svmModel, X_train, X_test, y_train, y_test)




#fitting model/classifier using the training set
tree_vanilla.fit(X_train, y_train)


#predicting test set
y_pred = tree_vanilla.predict(X_test)

#cm = confusion_matrix(y_test, y_pred)
#print(cm)
print("Info for regular OLD model==============")
print(tree_vanilla.score(X_test,y_test))
print(accuracy_score(y_test, y_pred))

print("=============================================")

# print("==============youtube code========")
# print("Tuned Decision Tree Params {}".format(tree_cv.best_params_))
# print("Best score is {}".format(tree_cv.best_score_))           #performs worse than accuracy_score(y_test, y_pred2) from above???

'''
#Random Forest Classifier
model = RandomForestClassifier()
model.fit(X_train, y_train)
y_pred = model.predict(X_test)
print(model.score(X_test,y_test))
print(accuracy_score(y_test, y_pred))
'''