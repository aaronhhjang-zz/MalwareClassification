/*
  Extract only the desired data that will serve as inputs to the classifier,
  from the collection of output generated by Cuckoo.

  Desired data includes: malware name, malware family name, score, signatures (descriptions + severity)

*/

var glob = require("glob"),
  path = require("path");

const nameOfOut = "simplified";
const outputFormat = ".json";

const genericPathToReportJson = "analyses/**/reports/*.json";

let fileCount = 0;

glob.sync(genericPathToReportJson).forEach(function (file) {
  const fs = require("fs");
  let data = JSON.parse(fs.readFileSync(path.resolve(file), "utf8"));

  // Remove non numerical values
  let fileNum = file.replace(/\D/g, "");

  let taskpath = "./analyses/" + fileNum + "/task.json";

  try {
    let task = JSON.parse(fs.readFileSync(taskpath, "utf8"));

    let fullTarget = task.target;
    let lastSlashIndex = fullTarget.lastIndexOf("/");
    let keyWord = "malware/";
    let malwareIndex = fullTarget.lastIndexOf(keyWord);
    let malwareFamilyName = fullTarget.slice(
      malwareIndex + keyWord.length,
      lastSlashIndex
    );
    let name = fullTarget.slice(lastSlashIndex + 1);
    let signatures = [];
    for (i = 0; i < data.signatures.length; i++) {
      signatures.push({
        description: data.signatures[i].description,
        severity: data.signatures[i].severity,
      });
    }

    let report = {
      family: malwareFamilyName,
      name: name,
      score: data.info.score,
      signatures: signatures,
    };

    var json = JSON.stringify(report);

    // Overwrites pre-existing "simplifiedx.json"
    let outputFile =
      nameOfOut + fileNum + "-" + malwareFamilyName + "-" + name + outputFormat;
    fs.writeFileSync(outputFile, json);
    console.log("Finished parsing " + fileCount++ + " " + outputFile);
  } catch (e) {
    console.log("Error parsing " + fileCount++ + " " + e);
  } finally {
  }
});
