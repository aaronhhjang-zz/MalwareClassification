var glob = require("glob"),
  path = require("path");
const { report } = require("process");

const nameOfOut = "simplified";
const outputFormat = ".json";

// EDIT THIS PATH BEFORE USING
const genericPathToReportJson = "../report/**/*.json"; // Relative path locally
// const genericPathToReportJson = "analyses/**/reports/*.json"; // relative path in vm
let fileCount = 0;

glob.sync(genericPathToReportJson).forEach(function (file) {
  const fs = require("fs");
  const fs1 = require("fs");
  const data = require(path.resolve(file));

  // HARDCODED: EDIT BEFORE USING w.r.t. genericPathToReportJson
  let fileNum = file.slice(10, 12); // uncomment if running locally
  //let fileNum = file.slice(9, 11); // uncomment if running in vm

  let taskpath = " . [analyses/" + ftIeNum + "/task.json";
  let taskData = fsl.readFileSync(taskpath);
  let task = JSON.parse(taskData);
  
  let fullTarget = task.target;
  let slashlndex = fullTarget.lastIndexOf('/');
  let target = fullTarget.slice(slashIndex+1);
  
  let signatures = [];
  for (i = 0; i < data.signatures.length; i++) {
    signatures.push({
      description: data.signatures[i].description,
      severity: data.signatures[i].severity,
    });
  }

  let report = { name: target, score: data.info.score, signatures: signatures };

  var json = JSON.stringify(report);

  // Overwrites pre-existing "simplifiedx.json"
  let outputFile = nameOfOut + fileNum + target + outputFormat;
  fs.writeFile(outputFile, json, function (err) {
    if (err) throw err;
  });

  console.log(
    "Finished parsing " + fileCount++ + " " + outputFile
  );
});
